<template>
  <div class="todolist-container">
    <!-- Â§¥ÈÉ®ÁªüËÆ° -->
    <el-row :gutter="20" class="stats-row">
      <el-col :xs="24" :sm="8">
        <el-card class="stat-card">
          <div class="stat-content">
            <el-icon :size="30" color="#409EFF"><Document /></el-icon>
            <div class="stat-info">
              <div class="stat-value">{{ statistics.totalTodos }}</div>
              <div class="stat-label">ÂÖ®ÈÉ®‰ªªÂä°</div>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :xs="24" :sm="8">
        <el-card class="stat-card">
          <div class="stat-content">
            <el-icon :size="30" color="#67C23A"><CircleCheck /></el-icon>
            <div class="stat-info">
              <div class="stat-value">{{ statistics.completedTodos }}</div>
              <div class="stat-label">Â∑≤ÂÆåÊàê</div>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :xs="24" :sm="8">
        <el-card class="stat-card">
          <div class="stat-content">
            <el-icon :size="30" color="#F56C6C"><Clock /></el-icon>
            <div class="stat-info">
              <div class="stat-value">{{ statistics.overdueTodos }}</div>
              <div class="stat-label">Â∑≤ËøáÊúü</div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- ‰∏ªÂç°Áâá -->
    <el-card>
      <template #header>
        <div class="header-content">
          <div class="header-left">
            <h2>üìã ÂæÖÂäû‰∫ãÈ°π</h2>
            <!-- Á≠õÈÄâÊ†áÁ≠æ -->
            <el-radio-group v-model="filterStatus" size="small" @change="loadTodos">
              <el-radio-button label="all">ÂÖ®ÈÉ®</el-radio-button>
              <el-radio-button label="active">ËøõË°å‰∏≠</el-radio-button>
              <el-radio-button label="completed">Â∑≤ÂÆåÊàê</el-radio-button>
            </el-radio-group>
          </div>
          <el-button type="primary" :icon="Plus" @click="openAddDialog">
            Êñ∞Âª∫ÂæÖÂäû
          </el-button>
        </div>
      </template>

      <!-- ÊêúÁ¥¢ÂíåÊéíÂ∫è -->
      <div class="toolbar">
        <el-input
          v-model="searchKeyword"
          placeholder="ÊêúÁ¥¢ÂæÖÂäû‰∫ãÈ°π..."
          :prefix-icon="Search"
          clearable
          style="width: 300px"
          @input="handleSearch"
        />
        <el-select v-model="sortBy" placeholder="ÊéíÂ∫èÊñπÂºè" style="width: 150px" @change="loadTodos">
          <el-option label="ÂàõÂª∫Êó∂Èó¥" value="createTime" />
          <el-option label="Êà™Ê≠¢Êó∂Èó¥" value="dueDate" />
          <el-option label="‰ºòÂÖàÁ∫ß" value="priority" />
        </el-select>
      </div>

      <!-- ÂæÖÂäûÂàóË°® -->
      <div v-loading="loading" class="todo-list">
        <template v-if="filteredTodos.length > 0">
          <div
            v-for="todo in filteredTodos"
            :key="todo.id"
            class="todo-item"
            :class="{ 'completed': todo.isCompleted, 'overdue': todo.isOverdue }"
          >
            <!-- Â∑¶‰æßÔºöÂ§çÈÄâÊ°Ü -->
            <el-checkbox
              :model-value="todo.isCompleted"
              @change="toggleComplete(todo)"
              size="large"
            />

            <!-- ‰∏≠Èó¥ÔºöÂÜÖÂÆπ -->
            <div class="todo-content" @click="openEditDialog(todo)">
              <div class="todo-title">
                <span :class="{ 'line-through': todo.isCompleted }">{{ todo.title }}</span>
                <el-tag
                  v-if="todo.priority"
                  :type="getPriorityType(todo.priority)"
                  size="small"
                  class="priority-tag"
                >
                  {{ getPriorityText(todo.priority) }}
                </el-tag>
              </div>
              <div class="todo-meta">
                <span v-if="todo.description" class="description">
                  {{ todo.description }}
                </span>
                <div class="meta-info">
                  <span v-if="todo.dueDate" class="due-date">
                    <el-icon><Clock /></el-icon>
                    {{ formatDueDate(todo.dueDate) }}
                    <span v-if="todo.daysUntilDue !== null" class="countdown">
                      ({{ getCountdownText(todo) }})
                    </span>
                  </span>
                  <span class="create-time">
                    <el-icon><Calendar /></el-icon>
                    {{ formatDate(todo.createTime) }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Âè≥‰æßÔºöÊìç‰ΩúÊåâÈíÆ -->
            <div class="todo-actions">
              <el-button
                :icon="Edit"
                circle
                size="small"
                @click="openEditDialog(todo)"
              />
              <el-button
                :icon="Delete"
                circle
                size="small"
                type="danger"
                @click="handleDelete(todo)"
              />
            </div>
          </div>
        </template>
        <el-empty v-else description="ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π">
          <el-button type="primary" :icon="Plus" @click="openAddDialog">
            ÂàõÂª∫Á¨¨‰∏Ä‰∏™ÂæÖÂäû
          </el-button>
        </el-empty>
      </div>
    </el-card>

    <!-- Ê∑ªÂä†/ÁºñËæëÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="dialogVisible"
      :title="isEdit ? 'ÁºñËæëÂæÖÂäû' : 'Êñ∞Âª∫ÂæÖÂäû'"
      width="600px"
    >
      <el-form
        ref="todoFormRef"
        :model="todoForm"
        :rules="rules"
        label-width="100px"
      >
        <el-form-item label="Ê†áÈ¢ò" prop="title">
          <el-input
            v-model="todoForm.title"
            placeholder="ËØ∑ËæìÂÖ•ÂæÖÂäû‰∫ãÈ°πÊ†áÈ¢ò"
            maxlength="200"
            show-word-limit
          />
        </el-form-item>

        <el-form-item label="ÊèèËø∞" prop="description">
          <el-input
            v-model="todoForm.description"
            type="textarea"
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•ÊèèËø∞ÔºàÂèØÈÄâÔºâ"
          />
        </el-form-item>

        <el-form-item label="‰ºòÂÖàÁ∫ß" prop="priority">
          <el-select v-model="todoForm.priority" placeholder="ËØ∑ÈÄâÊã©‰ºòÂÖàÁ∫ß">
            <el-option label="‰Ωé" value="LOW" />
            <el-option label="‰∏≠" value="MEDIUM" />
            <el-option label="È´ò" value="HIGH" />
          </el-select>
        </el-form-item>

        <el-form-item label="Êà™Ê≠¢Êó∂Èó¥" prop="dueDate">
          <el-date-picker
            v-model="todoForm.dueDate"
            type="datetime"
            placeholder="ÈÄâÊã©Êà™Ê≠¢Êó∂Èó¥ÔºàÂèØÈÄâÔºâ"
            format="YYYY-MM-DD HH:mm"
            value-format="YYYY-MM-DDTHH:mm:ss"
            :disabled-date="disabledDate"
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="dialogVisible = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" :loading="submitting" @click="handleSubmit">
          {{ isEdit ? '‰øùÂ≠ò' : 'ÂàõÂª∫' }}
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { todoService } from '@/services/todoService'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Plus,
  Edit,
  Delete,
  Search,
  Document,
  CircleCheck,
  Clock,
  Calendar
} from '@element-plus/icons-vue'
import { format } from 'date-fns'

const authStore = useAuthStore()
const userId = computed(() => authStore.currentUser?.id)

// Êï∞ÊçÆ
const todos = ref([])
const loading = ref(false)
const filterStatus = ref('all') // all, active, completed
const searchKeyword = ref('')
const sortBy = ref('createTime')

// ÁªüËÆ°Êï∞ÊçÆ
const statistics = reactive({
  totalTodos: 0,
  completedTodos: 0,
  overdueTodos: 0
})

// ÂØπËØùÊ°Ü
const dialogVisible = ref(false)
const isEdit = ref(false)
const submitting = ref(false)
const todoFormRef = ref(null)
const todoForm = reactive({
  id: null,
  title: '',
  description: '',
  priority: 'MEDIUM',
  dueDate: null,
  userId: null
})

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const rules = {
  title: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Ê†áÈ¢ò', trigger: 'blur' },
    { max: 200, message: 'Ê†áÈ¢ò‰∏çËÉΩË∂ÖËøá200‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  priority: [
    { required: true, message: 'ËØ∑ÈÄâÊã©‰ºòÂÖàÁ∫ß', trigger: 'change' }
  ]
}

// ËÆ°ÁÆóÂ±ûÊÄßÔºöËøáÊª§ÂêéÁöÑÂæÖÂäûÂàóË°®
const filteredTodos = computed(() => {
  let result = todos.value

  // ÊåâÁä∂ÊÄÅÁ≠õÈÄâ
  if (filterStatus.value === 'active') {
    result = result.filter(todo => !todo.isCompleted)
  } else if (filterStatus.value === 'completed') {
    result = result.filter(todo => todo.isCompleted)
  }

  // ÊêúÁ¥¢
  if (searchKeyword.value) {
    const keyword = searchKeyword.value.toLowerCase()
    result = result.filter(todo =>
      todo.title.toLowerCase().includes(keyword) ||
      (todo.description && todo.description.toLowerCase().includes(keyword))
    )
  }

  return result
})

// Âä†ËΩΩÂæÖÂäûÂàóË°®
const loadTodos = async () => {
  if (!userId.value) return

  loading.value = true
  try {
    const response = await todoService.getTodosByUserId(userId.value)
    if (response.code === 200) {
      todos.value = response.data || []
      sortTodos()
    }
  } catch (error) {
    console.error('Âä†ËΩΩÂæÖÂäûÂàóË°®Â§±Ë¥•:', error)
  } finally {
    loading.value = false
  }
}

// Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
const loadStatistics = async () => {
  if (!userId.value) return

  try {
    const response = await todoService.getStatistics(userId.value)
    if (response.code === 200) {
      Object.assign(statistics, response.data)
    }
  } catch (error) {
    console.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error)
  }
}

// ÊéíÂ∫è
const sortTodos = () => {
  todos.value.sort((a, b) => {
    if (sortBy.value === 'priority') {
      const priorityOrder = { HIGH: 3, MEDIUM: 2, LOW: 1 }
      return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0)
    } else if (sortBy.value === 'dueDate') {
      if (!a.dueDate) return 1
      if (!b.dueDate) return -1
      return new Date(a.dueDate) - new Date(b.dueDate)
    } else {
      // createTime
      return new Date(b.createTime) - new Date(a.createTime)
    }
  })
}

// ÊêúÁ¥¢
const handleSearch = () => {
  // Áî±ËÆ°ÁÆóÂ±ûÊÄßËá™Âä®Â§ÑÁêÜ
}

// ÊâìÂºÄÊ∑ªÂä†ÂØπËØùÊ°Ü
const openAddDialog = () => {
  isEdit.value = false
  resetForm()
  todoForm.userId = userId.value
  dialogVisible.value = true
}

// ÊâìÂºÄÁºñËæëÂØπËØùÊ°Ü
const openEditDialog = (todo) => {
  isEdit.value = true
  todoForm.id = todo.id
  todoForm.title = todo.title
  todoForm.description = todo.description || ''
  todoForm.priority = todo.priority
  todoForm.dueDate = todo.dueDate
  todoForm.userId = userId.value
  dialogVisible.value = true
}

// Êèê‰∫§Ë°®Âçï
const handleSubmit = async () => {
  if (!todoFormRef.value) return

  try {
    await todoFormRef.value.validate()
    submitting.value = true

    const data = {
      title: todoForm.title,
      description: todoForm.description || null,
      priority: todoForm.priority,
      dueDate: todoForm.dueDate || null,
      userId: todoForm.userId
    }

    let response
    if (isEdit.value) {
      response = await todoService.updateTodo(todoForm.id, data)
    } else {
      response = await todoService.createTodo(data)
    }

    if (response.code === 200) {
      ElMessage.success(isEdit.value ? 'Êõ¥Êñ∞ÊàêÂäü' : 'ÂàõÂª∫ÊàêÂäü')
      dialogVisible.value = false
      loadTodos()
      loadStatistics()
    }
  } catch (error) {
    console.error('Êèê‰∫§Â§±Ë¥•:', error)
  } finally {
    submitting.value = false
  }
}

// ÂàáÊç¢ÂÆåÊàêÁä∂ÊÄÅ
const toggleComplete = async (todo) => {
  const originalStatus = todo.isCompleted
  
  try {
    let response
    // Ê†πÊçÆÂΩìÂâçÁä∂ÊÄÅÂÜ≥ÂÆöË∞ÉÁî®Âì™‰∏™API
    // Â¶ÇÊûúÂΩìÂâçÂ∑≤ÂÆåÊàêÔºåÂàôÊ†áËÆ∞‰∏∫Êú™ÂÆåÊàêÔºõÂê¶ÂàôÊ†áËÆ∞‰∏∫ÂÆåÊàê
    if (originalStatus) {
      response = await todoService.markIncomplete(todo.id)
      ElMessage.success('Â∑≤Ê†áËÆ∞‰∏∫Êú™ÂÆåÊàê')
    } else {
      response = await todoService.markComplete(todo.id)
      ElMessage.success('Â∑≤Ê†áËÆ∞‰∏∫ÂÆåÊàê')
    }

    if (response.code === 200) {
      // ÈáçÊñ∞Âä†ËΩΩÂàóË°®ÂíåÁªüËÆ°Êï∞ÊçÆ
      await loadTodos()
      await loadStatistics()
    }
  } catch (error) {
    console.error('ÂàáÊç¢Áä∂ÊÄÅÂ§±Ë¥•:', error)
    // Â¶ÇÊûúÂ§±Ë¥•ÔºåÈáçÊñ∞Âä†ËΩΩ‰ª•ÊÅ¢Â§çÂéüÁä∂ÊÄÅ
    loadTodos()
  }
}

// Âà†Èô§ÂæÖÂäû
const handleDelete = (todo) => {
  ElMessageBox.confirm(
    `Á°ÆÂÆöË¶ÅÂà†Èô§ÂæÖÂäû"${todo.title}"ÂêóÔºü`,
    'ÊèêÁ§∫',
    {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }
  ).then(async () => {
    try {
      const response = await todoService.deleteTodo(todo.id)
      if (response.code === 200) {
        ElMessage.success('Âà†Èô§ÊàêÂäü')
        loadTodos()
        loadStatistics()
      }
    } catch (error) {
      console.error('Âà†Èô§Â§±Ë¥•:', error)
    }
  }).catch(() => {
    // ÂèñÊ∂àÂà†Èô§
  })
}

// ÈáçÁΩÆË°®Âçï
const resetForm = () => {
  todoForm.id = null
  todoForm.title = ''
  todoForm.description = ''
  todoForm.priority = 'MEDIUM'
  todoForm.dueDate = null
  todoForm.userId = null
  todoFormRef.value?.clearValidate()
}

// Á¶ÅÁî®ËøáÂéªÁöÑÊó•Êúü
const disabledDate = (time) => {
  return time.getTime() < Date.now() - 24 * 60 * 60 * 1000
}

// Ê†ºÂºèÂåñÊó•Êúü
const formatDate = (dateStr) => {
  if (!dateStr) return ''
  try {
    return format(new Date(dateStr), 'yyyy-MM-dd HH:mm')
  } catch {
    return dateStr
  }
}

const formatDueDate = (dateStr) => {
  if (!dateStr) return ''
  try {
    return format(new Date(dateStr), 'MMÊúàddÊó• HH:mm')
  } catch {
    return dateStr
  }
}

// Ëé∑ÂèñÂÄíËÆ°Êó∂ÊñáÊú¨
const getCountdownText = (todo) => {
  if (todo.isOverdue) {
    return `Â∑≤ËøáÊúü ${Math.abs(todo.daysUntilDue)} Â§©`
  } else if (todo.daysUntilDue === 0) {
    return '‰ªäÂ§©Âà∞Êúü'
  } else if (todo.daysUntilDue === 1) {
    return 'ÊòéÂ§©Âà∞Êúü'
  } else {
    return `ËøòÂâ© ${todo.daysUntilDue} Â§©`
  }
}

// Ëé∑Âèñ‰ºòÂÖàÁ∫ßÁ±ªÂûã
const getPriorityType = (priority) => {
  const types = {
    HIGH: 'danger',
    MEDIUM: 'warning',
    LOW: 'info'
  }
  return types[priority] || 'info'
}

// Ëé∑Âèñ‰ºòÂÖàÁ∫ßÊñáÊú¨
const getPriorityText = (priority) => {
  const texts = {
    HIGH: 'È´ò',
    MEDIUM: '‰∏≠',
    LOW: '‰Ωé'
  }
  return texts[priority] || priority
}

// ÂàùÂßãÂåñ
onMounted(() => {
  loadTodos()
  loadStatistics()
})
</script>

<style scoped>
.todolist-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0;
}

/* ÁªüËÆ°Âç°Áâá */
.stats-row {
  margin-bottom: 20px;
}

.stat-card {
  cursor: pointer;
  transition: all 0.3s;
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.stat-content {
  display: flex;
  align-items: center;
  gap: 16px;
}

.stat-info {
  flex: 1;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #303133;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 14px;
  color: #909399;
}

/* Â§¥ÈÉ® */
.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
}

.header-left h2 {
  margin: 0;
  font-size: 20px;
  color: #303133;
}

/* Â∑•ÂÖ∑Ê†è */
.toolbar {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

/* ÂæÖÂäûÂàóË°® */
.todo-list {
  min-height: 300px;
}

.todo-item {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  padding: 16px;
  border-bottom: 1px solid #EBEEF5;
  transition: all 0.3s;
}

.todo-item:hover {
  background-color: #F5F7FA;
}

.todo-item:last-child {
  border-bottom: none;
}

.todo-item.completed {
  opacity: 0.6;
}

.todo-item.overdue .todo-title {
  color: #F56C6C;
}

/* ÂæÖÂäûÂÜÖÂÆπ */
.todo-content {
  flex: 1;
  cursor: pointer;
  min-width: 0;
}

.todo-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 500;
  color: #303133;
  margin-bottom: 8px;
  flex-wrap: wrap;
}

.todo-title .line-through {
  text-decoration: line-through;
}

.priority-tag {
  flex-shrink: 0;
}

.todo-meta {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.description {
  font-size: 14px;
  color: #606266;
  word-break: break-word;
}

.meta-info {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  font-size: 13px;
  color: #909399;
}

.meta-info span {
  display: flex;
  align-items: center;
  gap: 4px;
}

.due-date {
  font-weight: 500;
}

.countdown {
  color: #F56C6C;
}

/* Êìç‰ΩúÊåâÈíÆ */
.todo-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

/* ÂìçÂ∫îÂºè */
@media (max-width: 768px) {
  .header-left {
    width: 100%;
    flex-direction: column;
    align-items: flex-start;
  }

  .toolbar {
    flex-direction: column;
  }

  .toolbar .el-input,
  .toolbar .el-select {
    width: 100% !important;
  }

  .todo-item {
    flex-direction: column;
  }

  .todo-actions {
    width: 100%;
    justify-content: flex-end;
  }
}
</style>
